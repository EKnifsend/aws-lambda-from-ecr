
# Creating a Lambda Function From an ECR image

This project includes the files to create a lambda function from an ecr image. Be mindful to replace <account-id> and <region> with your aws account id and aws region, respectively. These occur in the files app.py, aws_cdk_test/aws_cdk_test_stack.py, test-manual.yaml, test_generated.yaml. Both the lambda function and CDK script are written in python.

Before we begin, make sure you have created an aws account and setup Docker on your desktop. Also install and configure the AWS CLI. That can be done from this link: "https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html". To configure, create an IAM User for yourself in aws console and generate an access key. Be sure to save the secret_key somewhere secure. You can configure AWS CLI by running the command "aws configure" on the command line. You will need your public key, secret key, default region name (pick a region), and default output format (just use json). 

Here is an overview of some useful files in the repository:

 * app.py                                   the core cdk application script, initializes the app and calls the aws creation stack
 * aws_cdk_test/aws_cdk_test_stack.py       cdk script that creates an aws stack of the different desired aws components, this script creates a role and lambda function
 * lambda/lambda_handler.py                 python code for the lambda function itself
 * Dockerfile                               the dockerfile used to create the image which deploys the lambda function
 * policy.json                              json file that defines the creation of the role for the lambda function
 * README.CDK.md                            README file automatically generated when initializing a CDK project, includes helpful information for the CDK
 * README.Docker.md                         README file automatically generated when initializing Docker in a project
 * requirements.txt                         dependencies required for the python environment for runnning the CDK script
 * test_generated.yaml                      the cloudformation template generated by the CDK, for reference only
 * test-manual.yaml                         the cloudformation template used to create the lambda function without using CDK

 In the instructions below, be sure to replace all <> with your information.

 ## Using cloudformation without the CDK
Unlike the CDK, we will need to manually create, tag, and upload a docker image to ecr. 

1. First, build a docker image using the Dockerfile included. replace <image-name> with whatever you wish to decide to name your image. I named mine "ethan-test-image". If you use an arm-based mac and wish to test your image locally, replace the platform with "linux/arm64". However, for your image to run in aws, it must be built for x86 as specified below ("linux/amd64")
```
$ docker build --platform linux/amd64 -t <image-name> .
```

2. Then we will create an ecr repository. You can do this with a separate cloudformation template, but for ease we will just do it in terminal. Replace <your-ecr-repo> with whatever you wish to name the ecr repository that will store your image.
```
$ aws ecr create-repository --repository-name <your-ecr-repo>
```

3. Connect ecr and Docker. Replace <account-id> and <region> with your aws account id (viewable in console) and region (whatever you chose).
```
$ aws ecr get-login-password --region your-region | docker login --username AWS --password-stdin <account-id>.dkr.ecr.<region>.amazonaws.com
```

If the command above does not work, particularly if your error is "Cannot perform an interactive login from a non TTY device", try the following command (specified in this link: "https://stackoverflow.com/questions/60583847/aws-ecr-saying-cannot-perform-an-interactive-login-from-a-non-tty-device-after"). Remember to replace the <>'s
```
$ docker login -u AWS -p $(aws ecr get-login-password --region <region>) <account-id>.dkr.ecr.<region>.amazonaws.com
```

4. Tag your docker image. you should see a new image created in your local Docker desktop app.
```
$ docker tag <image-name>:latest <account-id>.dkr.ecr.<region>.amazonaws.com/<your-ecr-repo>:<image-name>
```

5. Push your image to ecr. 
```
$ docker push <account-id>.dkr.ecr.<region>.amazonaws.com/<your-ecr-repo>:<image-name>
```

6. If you go to AWS console, and go to Elastic Container Registry, you should be able to see a repository called <your-ecr-repo> with an image tagged <image-name>. Now, we will deploy the cloudformation template to create the lambda function. Go into test-manual.yaml and replace all the <>'s. Replace <your-lambda-function> with whatever you wish to name your lambda function. Then, run this command. Replace <your-cfn-stack> with whatever you wish to name your cloudformation stack. 
```
$ aws cloudformation create-stack --stack-name <your-cfn-stack> --template-body file://test-manual.yaml --capabilities CAPABILITY_IAM
```

If you go to AWS console and go to cloudformation, you should see your stack attempt to create. When it is done, you should see your lambda function with whatever you named it, and it should test successfully. If your stack has any issues creating, you should be able to see what under "Events". Be aware, if you wish to recreate your stack, you will need to delete your current stack, even if there was an error creating.

## Using CDK
1. Install and configure the AWS CDK CLI. The instructions for this are in the link: https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html#getting_started_install. The configuration for the CDK is done with the command 'cdk bootstrap' as specified in the documentation. It only needs to be done once. 

2. Set up a python environment to run the CDK script. The instructions to do so are specfied in README.CDK.md. 

3. Replace the <>'s in app.py and aws_cdk_test/aws_cdk_test_stack.py. 

Now simply run
```
$ cdk synth
$ cdk deploy
```

This should create an ecr image in the CDK repository generated by CDK when you ran 'cdk bootstrap', an IAM role called "lambda-basic-role", and create a lambda function called <your-lambda-function> deployed via the ecr image. Unfortunately, through this method, you cannot specify the image tag nor the repository to which the image is pushed to. Also be aware a new image is created an pushed to ecr each time you deploy your CDK script. To learn more about AWS CDK, I found this video to be a helpful guide in starting a CDK script: "https://www.youtube.com/watch?v=Vjkac2gfKuo&list=LL&index=10". 